<html>

<head>

  <title>Tomato Logger</title>
  <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css" />
  <script src="bower_components/jquery/dist/jquery.min.js"></script>
  <script src="bower_components/qwest/src/qwest.js"></script>
  <script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
  <script src="bower_components/ajax-form.js/index.js"></script>
  <script src="bower_components/handlebars/handlebars.min.js"></script>

</head>

<body>

  <nav class="navbar navbar-default navbar-static-top">
    <div class="container-fluid">
      <div class="row">
        <div class="col-xs-8">
          <img style="float: left; margin: 7px -7px 0 3px;" src="/img/tomato.png" width=35 height="35" />
          <span class="navbar-brand" style="margin-left: 0;">
            Pomodoro Meter
          </span>
        </div>
        <div class="col-xs-4">
          <p
          style="margin: 7px 0;"
          class="text-right">

            <span
            class="badge progress-bar-info ajax-view"
            data-api="/api/tomato"
            data-template="#tpl-tomato-count"></span>
            <script type="text/x-handlebars" id="tpl-tomato-count">
              <img src="/img/tomato.png" width="15" height="15" />
              {{count}}
            </script>

            <span
            class="ajax-view"
            data-api="/api/users/me"
            data-template="#tmpl-facebook-img"></span>
            <script type="text/x-handlebars" id="tmpl-facebook-img">
              <img src="http://graph.facebook.com/{{account.facebookId}}/picture" width="35" height="35" style="border-radius: 8px;" title="{{account.displayName}}" />
            </script>

          </p>
        </div>
      </div>
    </div>
  </nav>

  <div class="container-fluid">

    <form class="form ajax-form" onsubmit="return false;">

      <div class="form-group">
        <input class="form-control" name="title" placeholder="title" />
      </div>

      <div class="form-group">
        <input class="form-control" name="mood" placeholder="mood" />
      </div>

      <div class="form-group">
        <textarea class="form-control" name="notes" placeholder="notes"></textarea>
      </div>

      <div class="form-group">
        <input class="form-control" name="project" placeholder="project" />
      </div>


      <div class="form-group">
        <input class="form-control" name="tags" placeholder="tags" />
      </div>

      <div class="form-group">
        <button
          class="form-control"
          data-api="/api/tomato"
          data-method="put">Start Pomodoro</button>
      </div>

    </form>

    <div class="ajax-view" data-api="/api/tomato" data-template="#tmpl-tomato">
    </div>
    <script type="text/x-handlebars" id="tmpl-tomato">
      <div>
        {{#each items}}
          <hr />
          <p><img src="/img/tomato.png" width="15" height="15" /> {{title}}</p>
          <p>mood <span class="label label-default">{{mood}}</span></p>
          <p>notes <pre>{{notes}}</pre></p>
          <p>project <span class="label label-default">{{project}}</span></p>
          <p>
            tags
            {{#each tags}}
              <span class="label label-default">{{this}}</span>
            {{/each}}
          </p>
          <p>started at {{startedAt}}</p>
        {{/each}}
      </div>
    </script>

  </div>
    
<script>

var initAjaxView = function () {

    $('.ajax-view').each(function () {

        var $div = $(this);

        var api = $div.attr('data-api');
        var method = $div.attr('data-method') || 'get';
        var template = $div.attr('data-template');
        var responseType = $div.attr('data-response-type') || 'json';

        template = $(template).text().trim();

        var tmpl = Handlebars.compile(template);

        if (!api) {

            throw new Error('api is not specified: ' + api);

        }

        qwest[method](api, null, {responseType: responseType}).then(function (resp) {

            var html = tmpl(resp);

            $div.html(html);

        });

    });

};

$(function () {

    $('form.ajax-form').on('success.ajax-form', function () {

        location.reload();

    });

    initAjaxView();

});

</script>

</body>
</html>
